<project name="module-repository-lib" xmlns:artifact="antlib:org.apache.maven.artifact.ant">

    <property name="src.dir" value="src"/>
    <property name="module.repo.src.dir" value="${src.dir}/main/resources/modules/system/layers/base"/>
    <property name="output.dir" value="target/wildfly-${jboss.as.release.version}"/>
    <property name="module.repo.output.dir" value="${output.dir}/modules/system/layers/base"/>
    <property name="module.xml" value="module.xml"/>
    <property name="bundle.repo.output.dir" value="${output.dir}/bundles/system/layers/base"/>

    <macrodef name="module-def">
        <attribute name="name"/>
        <attribute name="slot" default="main"/>
        <element name="resources" implicit="yes" optional="yes"/>

        <sequential>
            <echo message="Yep ... Initializing module -> @{name}"/>
            <!-- Define module directory -->
            <define-module-dir name="@{name}" slot="@{slot}"/>

            <!-- Create module output directory -->
            <mkdir dir="${module.repo.output.dir}/${current.module.path}"/>

            <!-- Copy module.xml and related resources -->
            <copy todir="${module.repo.output.dir}/${current.module.path}">
                <fileset dir="${module.repo.src.dir}/${current.module.path}">
                    <include name="**"/>
                </fileset>
            </copy>

            <!-- Process resources -->
            <resources/>

            <!-- Clean up module.xml -->
            <replace file="${module.repo.output.dir}/${current.module.path}/${module.xml}">
                <replacetoken>
                    <![CDATA[
        <!-- Insert resources here -->]]></replacetoken>
                <replacevalue>
                </replacevalue>
            </replace>
        </sequential>
    </macrodef>

    <macrodef name="bundle-def">
        <attribute name="name"/>
        <attribute name="slot" default="main"/>
        <element name="resources" implicit="yes" optional="yes"/>

        <sequential>
            <echo message="Initializing bundle -> @{name}"/>
            <!-- Define bundle directory -->
            <define-bundle-dir name="@{name}" slot="@{slot}" />

            <!-- Create bundle output directory -->
            <mkdir dir="${bundle.repo.output.dir}/${current.bundle.path}"/>

            <!-- Process resources -->
            <resources/>
        </sequential>
    </macrodef>

    <macrodef name="maven-bundle">
        <attribute name="group"/>
        <attribute name="artifact"/>

        <sequential>
            <!-- Copy the jar to the bundle directory -->
            <copy todir="${bundle.repo.output.dir}/${current.bundle.path}" failonerror="true">
                <fileset file="${@{group}:@{artifact}:jar}"/>
                <mapper type="flatten" />
            </copy>
        </sequential>
    </macrodef>

    <scriptdef name="define-module-dir" language="javascript">
        <attribute name="name"/>
        <attribute name="slot"/>
        <![CDATA[
            name = attributes.get("name");
            name = name.replace(".", "/");
            project.setProperty("current.module.path", name + "/" + attributes.get("slot"));
        ]]>
    </scriptdef>



    <scriptdef name="define-bundle-dir" language="javascript">
        <attribute name="name"/>
        <attribute name="slot"/>
        <![CDATA[
            name = attributes.get("name");
            name = name.replace(".", "/");
            project.setProperty("current.bundle.path", name + "/" + attributes.get("slot"));
        ]]>
    </scriptdef>



    <macrodef name="maven-resource">
        <attribute name="group"/>
        <attribute name="artifact"/>

        <sequential>
            <!-- Copy the jar to the module directory -->
            <copy todir="${module.repo.output.dir}/${current.module.path}" failonerror="true">
                <fileset file="${@{group}:@{artifact}:jar}"/>
                <mapper type="flatten" />
            </copy>

            <basename file="${@{group}:@{artifact}:jar}" property="resourcename.@{group}.@{artifact}"/>
            <!-- Define the resource root -->
            <define-resource-root path="${resourcename.@{group}.@{artifact}}"/>
            <replace file="${module.repo.output.dir}/${current.module.path}/${module.xml}">
                <replacefilter token="&lt;!-- Insert resources here --&gt;" value="${current.resource.root}&#10;        &lt;!-- Insert resources here --&gt;"/>
            </replace>
        </sequential>
    </macrodef>

    <macrodef name="maven-resource-with-classifier">
        <attribute name="group"/>
        <attribute name="artifact"/>
        <attribute name="classifier"/>

        <sequential>
            <!-- Copy the jar to the module directory -->
            <copy todir="${module.repo.output.dir}/${current.module.path}" failonerror="true">
                <fileset file="${@{group}:@{artifact}:jar:@{classifier}}"/>
                <mapper type="flatten" />
            </copy>

            <basename file="${@{group}:@{artifact}:jar:@{classifier}}" property="resourcename.@{group}.@{artifact}.@{classifier}"/>

            <!-- Define the resource root -->
            <define-resource-root path="${resourcename.@{group}.@{artifact}.@{classifier}}"/>
            <replace file="${module.repo.output.dir}/${current.module.path}/${module.xml}">
                <replacefilter token="&lt;!-- Insert resources here --&gt;" value="${current.resource.root}&#10;        &lt;!-- Insert resources here --&gt;"/>
            </replace>
        </sequential>
    </macrodef>

    <macrodef name="extract-native-jar">
        <attribute name="group"/>
        <attribute name="artifact"/>
        <sequential>
            <unzip src="${@{group}:@{artifact}:jar}" dest="${module.repo.output.dir}/${current.module.path}">
                <patternset>
                    <include name="lib/**"/>
                </patternset>
            </unzip>
        </sequential>
    </macrodef>

    <scriptdef name="define-resource-root" language="javascript">
        <attribute name="path"/>
        <![CDATA[
            path = attributes.get("path");
            root = "<resource-root path=\"" + path + "\"/>";
            if (path.indexOf('${') != -1) {
                throw "Module resource root not found, make sure it is listed in build/pom.xml" + path;
            }
            project.setProperty("current.resource.root", root);
        ]]>
    </scriptdef>

</project>